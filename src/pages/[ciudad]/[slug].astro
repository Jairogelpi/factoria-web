---
import { createClient } from '@supabase/supabase-js';

// 1. Configuración del Cliente Supabase (Usando vars de entorno)
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

const { slug } = Astro.params;

// --- OBSERVABILIDAD (Start) ---
// Medimos cuánto tarda Supabase en responder para asegurar que no daña el SEO
const startMetric = performance.now();
let metricStatus = 'success';
// -----------------------------

// 2. Consulta a la Fuente de la Verdad
const { data, error } = await supabase
  .from('sites_factory')
  .select('seo_bundle')
  .eq('business_slug', slug)
  .single();

// --- OBSERVABILIDAD (End) ---
const endMetric = performance.now();
const duration = (endMetric - startMetric).toFixed(2);

if (error || !data) {
    metricStatus = 'error_not_found';
    console.error(`[OBSERVABILITY] ❌ Error fetching ${slug}: ${error?.message}`);
    return Astro.redirect('/404');
}

console.log(`[OBSERVABILITY] ⏱️ Renderizado SSR para: ${slug} | DB Latency: ${duration}ms | Status: ${metricStatus}`);
// -----------------------------

// 3. Extraer el Bundle para usar en el HTML
const bundle = data.seo_bundle;
const { content, meta } = bundle;

// 4. Cache-Control para SEO (Importante)
// Le decimos al navegador/Google que guarde esta versión 60 segundos.
// Esto hace que la web vuele si entra mucha gente seguida.
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60');
---

<html lang="es">
  <head>
    <title>{meta.title}</title>
    <meta name="description" content={meta.description} />
    </head>
  <body>
    <h1>{content.h1}</h1>
    <p>{content.about_text}</p>
    </body>
</html>