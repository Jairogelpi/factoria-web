---
import Reviews from '../../components/Reviews.astro';
import { Image } from 'astro:assets';
import SemanticNavigation from '../../components/SemanticNavigation.astro';

const { slug } = Astro.params;
const { ciudad } = Astro.params; // Capturamos la ciudad de la URL
// ... (rest of imports)

// ... (inside main tag, maybe after gallery or before FAQs?)
// Let's put it after "Sobre Nosotros" and "Nuestra Oferta", before Gallery.
// Actually, user didn't specify position, but Social Proof usually goes after Hero or Services.
// Looking at the file, line 118 is Gallery.
// Let's place it after Gallery for now, or maybe before FAQs.
// "Opiniones de nuestros clientes"

// Wait, I need to see where to insert.
// I'll insert it after the Gallery section.

    {/* Galer√≠a de Im√°genes */}
    {(bundle.media.gallery || []).length > 0 && (
        <div class="gallery-grid">
          {(bundle.media.gallery || []).map((img, index) => (
             <img 
               src={img.src} 
               alt={img.alt}
               loading="lazy"
               class="gallery-img"
               width="400" height="300"
             />
          ))}
        </div>
    )}

    {/* Rese√±as Din√°micas (Google Places) */}
    {location?.gbp?.placeId && (
        <section class="reviews-wrapper">
            <h3>Lo que dicen nuestros clientes</h3>
            <Reviews placeId={location.gbp.placeId} />
        </section>
    )}

// 1. OBTENCI√ìN UNIFICADA
// Incluye validaci√≥n, m√©tricas, latencia y Build Gates
const { bundle: safeBundle, bundle_hash } = await getClientBundle(slug as string);

// 2. GENERAR SCHEMA GRAPH
let graphSchema;
try {
  graphSchema = generateSchemaGraph(safeBundle, Astro.url.pathname);
  console.log(`[OBSERVABILITY] ‚úÖ Graph SEO generado para ${slug} (${graphSchema["@graph"].length} entidades)`);
} catch (e: any) {
  console.error(`[OBSERVABILITY] ‚ùå Error generando Graph SEO: ${e.message}`);
  // Recovery: Empty graph
  graphSchema = { "@context": "https://schema.org", "@graph": [] };
}

// 3. CACHE Y SEGURIDAD
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=3600');
Astro.response.headers.set('X-Bundle-Hash', bundle_hash);

// Observability Extra
const authorityScore = safeBundle.brand?.sameAs?.length || 0;
console.log(`[OBSERVABILITY] üíé SEO Divino: ${slug} | Autoridad: ${authorityScore} fuentes | Categor√≠a: ${safeBundle.content?.semantic_hierarchy?.category_name || 'N/A'}`);

const location = safeBundle.locations[0]; // Sede principal

// 4. Configuraci√≥n Ops
const ops = safeBundle.ops || { rum: { enabled: true } };

// 4. Configuraci√≥n Ops
const ops = safeBundle.ops || { rum: { enabled: true } };
---

<Layout bundle={safeBundle} ops={ops}>
  
  <main>
    {/* Breadcrumbs (Navegaci√≥n + SEO Estructural) */}
    <nav class="breadcrumbs" aria-label="breadcrumbs">
      <ol>
         <li><a href="/">Inicio</a></li>
         <li aria-hidden="true">&rsaquo;</li>
         <li><a href={`/${location?.address?.locality || 'localidad'}`}>{location?.address?.locality || 'Ciudad'}</a></li>
         <li aria-hidden="true">&rsaquo;</li>
         <li><span aria-current="page">{safeBundle.brand?.name || 'Negocio'}</span></li>
      </ol>
    </nav>

    <header class="hero-section">
      <Image 
        src={safeBundle.media?.hero?.url || safeBundle.multimedia?.hero} 
        alt={safeBundle.media?.hero?.alt || safeBundle.multimedia?.hero_image_alt_seo || `Foto principal de ${safeBundle.brand?.name}`}
        width={1200}
        height={600}
        format="avif"
        loading="eager"
        fetchpriority="high"
        class="hero-bg"
      />
      
      <div class="hero-content">
        <h1>{safeBundle.content?.home?.headline || safeBundle.content?.h1 || safeBundle.brand?.name}</h1>
        <p>{safeBundle.content?.home?.subheadline || safeBundle.perfil?.descripcion_corta || safeBundle.content?.subtitle}</p>
        
        {safeBundle.marketing?.voice_search_snippet && (
          <p class="voice-snippet">{safeBundle.marketing.voice_search_snippet}</p>
        )}


        {/* CTA: Soporte h√≠brido v1/v2 */}
        {(safeBundle.marketing?.estrategia_conversion?.cta_principal?.url || safeBundle.contacto?.reserva_url || safeBundle.content?.cta_primary?.url) && (
            <div class="cta-container">
              <a 
                href={safeBundle.marketing?.estrategia_conversion?.cta_principal?.url || safeBundle.contacto?.reserva_url || safeBundle.content?.cta_primary?.url} 
                class="btn-primary"
                aria-label={`Solicitar servicio en ${safeBundle.brand?.name} - ${safeBundle.marketing?.estrategia_conversion?.cta_principal?.texto || 'Contactar'}`}
              >
                {safeBundle.marketing?.estrategia_conversion?.cta_principal?.texto || "Reservar / Pedir"}
              </a>
              
              {(safeBundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Compra segura üîí") && (
                  <span class="microcopy-seguridad">
                    üîí {safeBundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Garant√≠a de Satisfacci√≥n"}
                  </span>
              )}
            </div>
        )}
      </div>
    </header>

    <section>
      <h2>Sobre Nosotros</h2>
      <p>{bundle.content.about?.text || bundle.brand.description}</p>
      
      <h3>Nuestra Oferta</h3>
      <ul>
        {(bundle.content.services || []).map((item) => (
          <li>
            <strong>{item.name}</strong>
            {bundle.content.semantic_definitions?.[item.slug] && (
               <p class="ai-definition">{bundle.content.semantic_definitions[item.slug]}</p>
            )}
          </li>
        ))}
      </ul>
      
    {/* Galer√≠a de Im√°genes */}
      {(bundle.media.gallery || []).length > 0 && (
        <div class="gallery-grid">
          {(bundle.media.gallery || []).map((img, index) => (
             <Image 
               src={img.src} 
               alt={img.alt}
               width={400} 
               height={300}
               format="avif"
               loading="lazy"
               class="gallery-img"
             />
          ))}
        </div>
      )}

      {/* Rese√±as Din√°micas (Google Places) */}
      {location?.gbp?.placeId && <Reviews placeId={location.gbp.placeId} />}
    </section>

    {/* Secci√≥n FAQs */}
    {(bundle.content.faq || []).length > 0 && (
      <section class="faqs-section">
        <h3>Preguntas Frecuentes</h3>
        <dl>
          {(bundle.content.faq || []).map((faq) => (
            <>
              <dt>{faq.q}</dt>
              <dd>{faq.a}</dd>
            </>
          ))}
        </dl>
      </section>
    )}

    {/* Navegaci√≥n Sem√°ntica (Cluster de Autoridad) */}
    {/* SECCI√ìN SEM√ÅNTICA (Cluster de Autoridad) */}
    <SemanticNavigation 
      bundle={safeBundle} 
      ciudad={ciudad || 'local'} 
    />

    {/* Footer Legal (Defensive Coding: No renderizar si no hay datos legales) */}
    {safeBundle.legal && (
      <footer class="site-footer">
        <p>&copy; {new Date().getFullYear()} {safeBundle.brand.name}. {safeBundle.legal.companyName ? `Operado por ${safeBundle.legal.companyName}` : ''}</p>
        <nav class="legal-nav">
          <a href="/legal/aviso-legal">Aviso Legal</a>
          <a href="/legal/privacidad">Pol√≠tica de Privacidad</a>
          {safeBundle.legal.includeCookieBanner && <a href="#" onclick="javascript:openCookieSettings(); return false;">Cookies</a>}
        </nav>
      </footer>
    )}

  </main>
</Layout>

<style>
  .hero-section {
    position: relative;
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: white;
    text-align: center;
  }

  .hero-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    filter: brightness(0.6);
  }

  .hero-content {
    position: relative;
    z-index: 1;
    padding: 2rem;
    max-width: 800px;
  }

  h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  
  /* Voice Snippet: Visible pero sutil, ideal para "Featured Snippets" */
  .voice-snippet {
    font-size: 1.1rem;
    font-style: italic;
    opacity: 0.9;
    margin-bottom: 1.0rem; /* Reducido para acercar estrellas */
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .rating-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-weight: bold;
    color: #f1c40f; /* Gold color */
  }
  .stars {
    font-size: 1.3rem;
  }
  .rating-text {
    color: white;
    font-size: 0.95rem;
    opacity: 0.9;
  }

  /* CTA Container God Mode */
  .cta-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .btn-primary {
    display: inline-block;
    background: #ff4757;
    color: white;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 50px; /* Rounded modern style */
    font-weight: 800;
    font-size: 1.2rem;
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
  }
  
  .btn-primary:hover {
    background: #ff6b81;
    transform: translateY(-2px);
  }

  .microcopy-seguridad {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .badge {
    background: #feca57;
    color: #333;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    display: inline-block;
    font-weight: bold;
    margin-top: 2rem;
  }

  main {
    font-family: 'Inter', system-ui, sans-serif; /* Modern font stack */
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .gallery-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }

  .gallery-img:hover {
    transform: scale(1.02);
  }
  
  /* Breadcrumbs */
  .breadcrumbs ol {
    display: flex;
    list-style: none;
    padding: 1rem 2rem;
    font-size: 0.9rem;
    color: #666;
    background: #f9f9f9;
  }
  .breadcrumbs a {
    color: #444;
    text-decoration: none;
  }
  .breadcrumbs a:hover {
    text-decoration: underline;
  }
  
  /* FAQs */
  .faqs-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
  dt {
    font-weight: bold;
    margin-top: 1rem;
    color: #333;
  }
  dd {
    margin-left: 0;
    margin-bottom: 1rem;
    color: #555;
  }
  
  /* CLS Prevention */
  img {
    max-width: 100%;
    height: auto;
    /* Aspect-ratio hints (can be overridden by inline styles) */
    aspect-ratio: attr(width) / attr(height); 
  }
  .hero-bg {
    /* Hardcoded hero aspect ratio fallback */
    aspect-ratio: 16/9; 
  }
  /* Footer Styles */
  .site-footer {
    margin-top: 4rem;
    padding: 2rem;
    background: #f1f2f6;
    text-align: center;
    font-size: 0.9rem;
    color: #747d8c;
    border-top: 1px solid #dfe4ea;
  }
  .legal-nav {
    margin-top: 0.5rem;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
  }
  .legal-nav a {
    color: #57606f;
    text-decoration: none;
  }
  .legal-nav a:hover {
    text-decoration: underline;
  }
  .ai-definition {
    font-size: 0.9rem;
    color: #2d3436;
    background: #e1f5fe;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    margin-top: 0.3rem;
    font-style: italic;
    border-left: 3px solid #03a9f4;
  }
</style>
