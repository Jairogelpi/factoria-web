---
import Layout from '../../layouts/Layout.astro'; // Aseg√∫rate de importar tu Layout
import { createClient } from '@supabase/supabase-js';

// 1. Configuraci√≥n Cliente Supabase
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

const { slug } = Astro.params;

// 1. Definici√≥n de campos cr√≠ticos para SEO 2026 (Unified Contract)
const CRITICAL_FIELDS = [
  { path: 'brand.name', label: 'Nombre Comercial' },
  { path: 'content.home.headline', label: 'H1 SEO' },
  { path: 'seo.defaultDescription', label: 'Meta Descripci√≥n' },
  { path: 'media.hero', label: 'Imagen Hero' }
];

// 2. Funci√≥n de Validaci√≥n (Build Gate)
function validateSeoBundle(bundle: any) {
  const missing = CRITICAL_FIELDS.filter(field => {
    const value = field.path.split('.').reduce((obj, key) => obj?.[key], bundle);
    return !value || value === "";
  });

  if (missing.length > 0) {
    const errorMsg = `[BUILD GATE] ‚ùå Error cr√≠tico en "${slug}": Faltan campos: ${missing.map(f => f.label).join(', ')}`;
    console.error(errorMsg);
    // En SSR esto enviar√° un error 500; en SSG romper√° el proceso de build
    throw new Error(errorMsg);
  }
}

// --- OBSERVABILIDAD (Start) ---
const startMetric = performance.now();
let metricStatus = 'success';

// 2. Consulta a la Fuente de la Verdad
// NOTA: Aseg√∫rate de que en Supabase tienes estas columnas o que el JSON las incluye.
// Si guardaste todo en 'seo_bundle', ajusta la desestructuraci√≥n abajo.
const { data, error } = await supabase
  .from('sites_factory')
  .select('seo_bundle, schema_json_ld') // Pedimos Datos + Schema
  .eq('business_slug', slug)
  .single();

const endMetric = performance.now();
const duration = (endMetric - startMetric).toFixed(2);

if (error || !data) {
    metricStatus = 'error_not_found';
    console.error(`[OBSERVABILITY] ‚ùå Error fetching ${slug}: ${error?.message}`);
    return Astro.redirect('/404');
}

console.log(`[OBSERVABILITY] ‚è±Ô∏è Renderizado SSR para: ${slug} | DB Latency: ${duration}ms`);
// -----------------------------

// 3. Extraer el Bundle (Unified Contract)
const bundle = data.seo_bundle; 
const schema = data.schema_json_ld;

// Parseamos si viene como string
const safeBundle = typeof bundle === 'string' ? JSON.parse(bundle) : bundle;
const safeSchema = typeof schema === 'string' ? JSON.parse(schema) : schema;

// 3.1 Enriquecer Schema con "Authority Map" (mentions)
if (safeBundle.content?.semantic_entities && Array.isArray(safeBundle.content.semantic_entities)) {
  safeSchema.mentions = safeBundle.content.semantic_entities.map((url: string) => ({
    "@type": "Thing",
    "@id": url,
    "name": url.split('/').pop()?.replace(/_/g, ' ') || url
  }));
}

// 3.2 Breadcrumb de Entidad (Jerarqu√≠a Sem√°ntica)
const semantic = safeBundle.content?.semantic_hierarchy;
if (semantic) {
  const permalink = Astro.url.href;
  const baseUrl = new URL(permalink).origin;
  
  const breadcrumbSchema = {
    "@type": "BreadcrumbList",
    "@id": `${permalink}#breadcrumb`,
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Inicio", "item": baseUrl },
      { 
        "@type": "ListItem", 
        "position": 2, 
        "name": safeBundle.locations?.[0]?.address?.locality || "Localidad", 
        "item": `${baseUrl}/${(safeBundle.locations?.[0]?.address?.locality || "localidad").toLowerCase()}` 
      },
      { "@type": "ListItem", "position": 3, "name": semantic.category_name, "item": semantic.category_url },
      { "@type": "ListItem", "position": 4, "name": safeBundle.brand?.name, "item": permalink }
    ]
  };

  if (Array.isArray(safeSchema)) {
    safeSchema.push(breadcrumbSchema);
  } else if (safeSchema["@graph"]) {
     safeSchema["@graph"].push(breadcrumbSchema);
  }
}

// --- OBSERVABILIDAD (Authority) ---
const authorityScore = safeBundle.brand?.sameAs?.length || 0;
console.log(`[OBSERVABILITY] üíé SEO Divino: ${slug} | Autoridad: ${authorityScore} fuentes | Categor√≠a: ${safeBundle.content?.semantic_hierarchy?.category_name || 'N/A'}`);

// Validar estructura b√°sica o location
if (!safeBundle.locations || safeBundle.locations.length === 0) {
    throw new Error(`[BUILD GATE] ‚ùå Bundle inv√°lido: Sin locations definidas.`);
}

const location = safeBundle.locations[0]; // Sede principal

// EJECUCI√ìN DEL GATE: Validar antes de proceder
validateSeoBundle(safeBundle);

// 4. PREPARAR PROPS PARA EL LAYOUT (SEO)
const seoProps = {
  meta_title: safeBundle.seo?.defaultTitlePattern
    ? safeBundle.seo.defaultTitlePattern
        .replace('{page}', safeBundle.content?.home?.headline || 'Inicio')
        .replace('{brand}', safeBundle.brand?.name || 'Marca')
    : `${safeBundle.brand?.name} | Web Oficial`,
  meta_description: safeBundle.seo?.defaultDescription || safeBundle.brand?.description,
  canonical_path: slug, // O usar location.slug si est√° disponible
  og_image: safeBundle.media?.ogImage || safeBundle.media?.hero
};

// 5. Cache-Control
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60');

// 6. Extra Meta (Voice Snippet & RUM Control)
const extraMeta = [];
if (safeBundle.marketing?.voice_search_snippet) {
  extraMeta.push({
    name: "ai-voice-snippet",
    content: safeBundle.marketing.voice_search_snippet
  });
}

// Configuraci√≥n de RUM desde el bundle (Ops)
const ops = safeBundle.ops || { rum: { enabled: true } };
---

<Layout seo={seoProps} schema_jsonld={safeSchema} extra_meta={extraMeta} ops={ops}>
  
  <main>
    {/* Breadcrumbs (Navegaci√≥n + SEO Estructural) */}
    <nav class="breadcrumbs" aria-label="breadcrumbs">
      <ol>
         <li><a href="/">Inicio</a></li>
         <li aria-hidden="true">&rsaquo;</li>
         <li><a href={`/${location?.address?.city || 'caceres'}`}>{location?.address?.city || 'Ciudad'}</a></li>
         <li aria-hidden="true">&rsaquo;</li>
         <li><span aria-current="page">{safeBundle.brand?.name || 'Negocio'}</span></li>
      </ol>
    </nav>

    <header class="hero-section">
      <img 
        src={safeBundle.multimedia?.hero_image_url || safeBundle.multimedia?.hero} 
        alt={safeBundle.multimedia?.hero_image_alt_seo || `Foto principal de ${safeBundle.perfil?.nombre_comercial || safeBundle.content?.h1}`}
        class="hero-bg"
        fetchpriority="high"
        width="1200" height="600" 
      />
      
      <div class="hero-content">
        {/* H1: Soporte para estructura v2 (marketing) y v1 (content.h1) */}
        <h1>{safeBundle.marketing?.hero_copy?.h1_seo || safeBundle.content?.h1 || safeBundle.perfil?.nombre_comercial}</h1>
        <p>{safeBundle.perfil?.descripcion_corta || safeBundle.content?.subtitle}</p>
        
        {/* Voice Search Snippet */}
        {safeBundle.marketing?.voice_search_snippet && (
          <p class="voice-snippet">{safeBundle.marketing.voice_search_snippet}</p>
        )}

        {/* Social Proof: Estrellas Visuales (Coinciden con Schema) */}
        {(safeBundle.social_proof?.rating || safeBundle.content?.social?.rating) && (
             <div class="rating-container">
               <span class="stars">{'‚òÖ'.repeat(Math.round(safeBundle.social_proof?.rating || safeBundle.content?.social?.rating || 5))}</span>
               <span class="rating-text">
                 {safeBundle.social_proof?.rating || safeBundle.content?.social?.rating}/5 
                 ({safeBundle.social_proof?.reviews_count || safeBundle.content?.social?.reviews_count || '100+'} opiniones)
               </span>
             </div>
        )}

        {/* CTA: Soporte h√≠brido v1/v2 */}
        {(safeBundle.marketing?.estrategia_conversion?.cta_principal?.url || safeBundle.contacto?.reserva_url || safeBundle.content?.cta_primary?.url) && (
            <div class="cta-container">
              <a 
                href={safeBundle.marketing?.estrategia_conversion?.cta_principal?.url || safeBundle.contacto?.reserva_url || safeBundle.content?.cta_primary?.url} 
                class="btn-primary"
              >
                {safeBundle.marketing?.estrategia_conversion?.cta_principal?.texto || "Reservar / Pedir"}
              </a>
              
              {(safeBundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Compra segura üîí") && (
                  <span class="microcopy-seguridad">
                    üîí {safeBundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Garant√≠a de Satisfacci√≥n"}
                  </span>
              )}
            </div>
        )}
      </div>
    </header>

    <section>
      <h2>Sobre Nosotros</h2>
      <p>{safeBundle.content?.about?.text || safeBundle.brand?.description}</p>
      
      <h3>Nuestra Oferta</h3>
      <ul>
        {(safeBundle.content?.services || []).map((item: string) => (
          <li>{item}</li>
        ))}
      </ul>
      
      {/* Galer√≠a de Im√°genes */}
      {(safeBundle.media?.gallery || []).length > 0 && (
        <div class="gallery-grid">
          {(safeBundle.media.gallery).map((imgUrl: string, index: number) => (
             <img 
               src={imgUrl} 
               alt={`Galer√≠a ${safeBundle.brand?.name} - Foto ${index + 1}`}
               loading="lazy"
               class="gallery-img"
               width="400" height="300"
             />
          ))}
        </div>
      )}
    </section>

    {/* Secci√≥n FAQs */}
    {(safeBundle.content?.faqs || []).length > 0 && (
      <section class="faqs-section">
        <h3>Preguntas Frecuentes</h3>
        <dl>
          {(safeBundle.content.faqs).map((faq: any) => (
            <>
              <dt>{faq.question}</dt>
              <dd>{faq.answer}</dd>
            </>
          ))}
        </dl>
      </section>
    )}
    
    {(safeBundle.socialProof?.trustBadge) && (
        <div class="badge">üèÜ {safeBundle.socialProof.trustBadge}</div>
    )}

  </main>
</Layout>

<style>
  .hero-section {
    position: relative;
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: white;
    text-align: center;
  }

  .hero-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    filter: brightness(0.6);
  }

  .hero-content {
    position: relative;
    z-index: 1;
    padding: 2rem;
    max-width: 800px;
  }

  h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  
  /* Voice Snippet: Visible pero sutil, ideal para "Featured Snippets" */
  .voice-snippet {
    font-size: 1.1rem;
    font-style: italic;
    opacity: 0.9;
    margin-bottom: 1.0rem; /* Reducido para acercar estrellas */
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .rating-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-weight: bold;
    color: #f1c40f; /* Gold color */
  }
  .stars {
    font-size: 1.3rem;
  }
  .rating-text {
    color: white;
    font-size: 0.95rem;
    opacity: 0.9;
  }

  /* CTA Container God Mode */
  .cta-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .btn-primary {
    display: inline-block;
    background: #ff4757;
    color: white;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 50px; /* Rounded modern style */
    font-weight: 800;
    font-size: 1.2rem;
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
  }
  
  .btn-primary:hover {
    background: #ff6b81;
    transform: translateY(-2px);
  }

  .microcopy-seguridad {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .badge {
    background: #feca57;
    color: #333;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    display: inline-block;
    font-weight: bold;
    margin-top: 2rem;
  }

  main {
    font-family: 'Inter', system-ui, sans-serif; /* Modern font stack */
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .gallery-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }

  .gallery-img:hover {
    transform: scale(1.02);
  }
  
  /* Breadcrumbs */
  .breadcrumbs ol {
    display: flex;
    list-style: none;
    padding: 1rem 2rem;
    font-size: 0.9rem;
    color: #666;
    background: #f9f9f9;
  }
  .breadcrumbs a {
    color: #444;
    text-decoration: none;
  }
  .breadcrumbs a:hover {
    text-decoration: underline;
  }
  
  /* FAQs */
  .faqs-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #eee;
  }
  dt {
    font-weight: bold;
    margin-top: 1rem;
    color: #333;
  }
  dd {
    margin-left: 0;
    margin-bottom: 1rem;
    color: #555;
  }
  
  /* CLS Prevention */
  img {
    max-width: 100%;
    height: auto;
    /* Aspect-ratio hints (can be overridden by inline styles) */
    aspect-ratio: attr(width) / attr(height); 
  }
  .hero-bg {
    /* Hardcoded hero aspect ratio fallback */
    aspect-ratio: 16/9; 
  }
</style>
