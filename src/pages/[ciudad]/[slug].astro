---
import Layout from '../../layouts/Layout.astro'; // Aseg√∫rate de importar tu Layout
import { createClient } from '@supabase/supabase-js';

// 1. Configuraci√≥n Cliente Supabase
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

const { slug } = Astro.params;

// --- OBSERVABILIDAD (Start) ---
const startMetric = performance.now();
let metricStatus = 'success';

// 2. Consulta a la Fuente de la Verdad
// NOTA: Aseg√∫rate de que en Supabase tienes estas columnas o que el JSON las incluye.
// Si guardaste todo en 'seo_bundle', ajusta la desestructuraci√≥n abajo.
const { data, error } = await supabase
  .from('sites_factory')
  .select('seo_bundle, schema_json_ld') // Pedimos Datos + Schema
  .eq('business_slug', slug)
  .single();

const endMetric = performance.now();
const duration = (endMetric - startMetric).toFixed(2);

if (error || !data) {
    metricStatus = 'error_not_found';
    console.error(`[OBSERVABILITY] ‚ùå Error fetching ${slug}: ${error?.message}`);
    return Astro.redirect('/404');
}

console.log(`[OBSERVABILITY] ‚è±Ô∏è Renderizado SSR para: ${slug} | DB Latency: ${duration}ms`);
// -----------------------------

// 3. Extraer el Bundle (La nueva estructura v2.0)
const bundle = data.seo_bundle; // Tu Golden Record
const schema = data.schema_json_ld; // Tu Grafo perfecto

// 4. PREPARAR PROPS PARA EL LAYOUT (SEO)
// Mapeamos tu JSON complejo a las props simples que espera el Layout
const seoProps = {
  meta_title: `${bundle.perfil.nombre_comercial} en ${bundle.ubicacion.ciudad} | Web Oficial`,
  meta_description: bundle.perfil.descripcion_corta,
  // Usamos el slug real para que coincida con el @id del Schema
  canonical_path: `${bundle.ubicacion.ciudad}/${slug}`, 
  og_image: bundle.multimedia.hero_image_url
};

// 5. Cache-Control (Vital para rendimiento en Edge)
Astro.response.headers.set('Cache-Control', 'public, max-age=60, s-maxage=60');
---

<Layout seo={seoProps} schema_jsonld={schema}>
  
  <main>
    <header class="hero-section">
      <img 
        src={bundle.multimedia.hero_image_url} 
        alt={bundle.multimedia.hero_image_alt_seo || `Foto principal de ${bundle.perfil.nombre_comercial}`}
        class="hero-bg"
        fetchpriority="high" 
      />
      
      <div class="hero-content">
        <h1>{bundle.perfil.nombre_comercial}</h1>
        <p>{bundle.perfil.descripcion_corta}</p>
        
        {/* Voice Search Snippet: Optimizaci√≥n para b√∫squedas por voz */}
        {bundle.marketing?.voice_search_snippet && (
          <p class="voice-snippet">{bundle.marketing.voice_search_snippet}</p>
        )}

        {/* CTA "God Mode" con Microcopy */}
        {(bundle.marketing?.estrategia_conversion?.cta_principal?.url || bundle.contacto.reserva_url) && (
            <div class="cta-container">
              <a 
                href={bundle.marketing?.estrategia_conversion?.cta_principal?.url || bundle.contacto.reserva_url} 
                class="btn-primary"
              >
                {bundle.marketing?.estrategia_conversion?.cta_principal?.texto || "Reservar / Pedir"}
              </a>
              
              {(bundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Compra segura üîí") && (
                  <span class="microcopy-seguridad">
                    üîí {bundle.marketing?.estrategia_conversion?.microcopy_seguridad || "Garant√≠a de Satisfacci√≥n"}
                  </span>
              )}
            </div>
        )}
      </div>
    </header>

    <section>
      <h2>Sobre Nosotros</h2>
      <p>{bundle.perfil.descripcion_larga}</p>
      
      <h3>Nuestra Oferta</h3>
      <ul>
        {(bundle.contenido_seo.lista_servicios || []).map((item: string) => (
          <li>{item}</li>
        ))}
      </ul>
    </section>
    
    {bundle.social_proof.badge_confianza && (
        <div class="badge">üèÜ {bundle.social_proof.badge_confianza}</div>
    )}

  </main>
</Layout>

<style>
  .hero-section {
    position: relative;
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    color: white;
    text-align: center;
  }

  .hero-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
    filter: brightness(0.6);
  }

  .hero-content {
    position: relative;
    z-index: 1;
    padding: 2rem;
    max-width: 800px;
  }

  h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  
  /* Voice Snippet: Visible pero sutil, ideal para "Featured Snippets" */
  .voice-snippet {
    font-size: 1.1rem;
    font-style: italic;
    opacity: 0.9;
    margin-bottom: 1.5rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  /* CTA Container God Mode */
  .cta-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .btn-primary {
    display: inline-block;
    background: #ff4757;
    color: white;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 50px; /* Rounded modern style */
    font-weight: 800;
    font-size: 1.2rem;
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
  }
  
  .btn-primary:hover {
    background: #ff6b81;
    transform: translateY(-2px);
  }

  .microcopy-seguridad {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .badge {
    background: #feca57;
    color: #333;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    display: inline-block;
    font-weight: bold;
    margin-top: 2rem;
  }

  main {
    font-family: 'Inter', system-ui, sans-serif; /* Modern font stack */
  }
</style>
