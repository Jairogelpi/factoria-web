---
// Layout.astro
type Seo = {
  meta_title?: string;
  meta_description?: string;
  canonical_path?: string;
  og_image?: string;
};

// Props: Ahora aceptamos 'schema_jsonld' y 'extra_meta'
const { seo, schema_jsonld, extra_meta = [], ops = { rum: { enabled: true } } } = Astro.props;

const base = import.meta.env.PUBLIC_BASE_URL || "https://factoria-web.pages.dev";
// LÃ³gica de canonical (Correcta)
const canonicalPath = (seo?.canonical_path || "").replace(/^\//, "");
const canonicalUrl = canonicalPath
  ? `${base.replace(/\/$/, "")}/${canonicalPath}`
  : base;

const title = seo?.meta_title || "";
const description = seo?.meta_description || "";

// LÃ³gica de OG Image (Correcta)
const ogImage = seo?.og_image
  ? (seo.og_image.startsWith("http") ? seo.og_image : `${base.replace(/\/$/, "")}/${seo.og_image.replace(/^\//, "")}`)
  : "";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
    {title && <title>{title}</title>}
    {description && <meta name="description" content={description} />}

    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    {title && <meta property="og:title" content={title} />}
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalUrl} />
    {ogImage && <meta property="og:image" content={ogImage} />}

    <!-- Twitter Card (SEO TÃ©cnico) -->
    <meta name="twitter:card" content="summary_large_image" />
    {title && <meta name="twitter:title" content={title} />}
    {description && <meta name="twitter:description" content={description} />}
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    {extra_meta.map((meta: any) => (
       <meta name={meta.name} content={meta.content} />
    ))}

    {schema_jsonld && (
      <script type="application/ld+json" set:html={JSON.stringify(schema_jsonld)} />
    )}
    {ops.rum?.enabled && (
      <script is:inline>
        // FunciÃ³n para enviar mÃ©tricas a tu sistema o analÃ­tica
        const sendToAnalytics = ({ name, value, id }) => {
          const body = JSON.stringify({ name, value, id, url: window.location.href });
          // Usamos sendBeacon para no bloquear la descarga de la pÃ¡gina
          if (navigator.sendBeacon) {
            navigator.sendBeacon('/api/metrics', body);
          } else {
            fetch('/api/metrics', { body, method: 'POST', keepalive: true });
          }
          console.log(`[RUM] ðŸ“Š ${name}: ${value}`);
        };

        // Observador de mÃ©tricas Core Web Vitals
        if ('PerformanceObserver' in window) {
          try {
            const po = new PerformanceObserver((list) => {
              for (const entry of list.getEntries()) {
                // Filtramos por mÃ©tricas crÃ­ticas de 2026 (LCP, CLS, INP)
                if (['largest-contentful-paint', 'layout-shift', 'first-input'].includes(entry.entryType)) {
                   sendToAnalytics({
                     name: entry.entryType,
                     value: entry.startTime || entry.value,
                     id: entry.name
                   });
                }
              }
            });
            po.observe({ type: 'largest-contentful-paint', buffered: true });
            po.observe({ type: 'layout-shift', buffered: true });
            po.observe({ type: 'first-input', buffered: true });
          } catch (e) {
            console.error('[RUM] Error initializing observer:', e);
          }
        }
      </script>
    )}

    <script type="speculationrules">
    {
      "prerender": [
        {
          "source": "list",
          "urls": ["/"],
          "score": 0.5
        },
        {
          "where": { "href_matches": "/*" },
          "eagerness": "moderate"
        }
      ]
    }
    </script>
    
    <script>
      // Observabilidad de Speculation Rules
      if (HTMLScriptElement.supports && HTMLScriptElement.supports('speculationrules')) {
        console.log('[OBSERVABILITY] ðŸš€ Speculation Rules activas (0ms loading ready)');
      }
    </script>
  </head>
  <body>
    <slot />
  </body>
</html>