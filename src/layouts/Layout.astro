---
// Layout.astro
import SEO from '../components/SEO.astro';
import type { ClientSEOBundle } from '../types/ClientBundle';

interface Props {
  bundle: ClientSEOBundle;
  ops?: { rum: { enabled: boolean } };
  extra_meta?: any[]; // Keep for backward compatibility if needed, though SEO.astro handles most
}

const { bundle, ops = { rum: { enabled: true } } } = Astro.props;

// --- OBSERVABILIDAD DE SEGURIDAD ---
// Verifica si estamos sirviendo con headers seguros (Nota: En local/dev puede fallar, es esperado)
const securityCheck = Astro.response.headers.get('Content-Security-Policy');
if (!securityCheck && import.meta.env.PROD) {
  // Nota: Cloudflare _headers aplica fuera de Astro, pero si us√°ramos middleware lo ver√≠amos aqu√≠.
  // Mantenemos el log para confirmar si Astro mismo est√° endurecido.
  console.log('[OBSERVABILITY] ‚ÑπÔ∏è CSP gestionado por Edge (Cloudflare)');
} else if (securityCheck) {
  console.log('[OBSERVABILITY] üõ°Ô∏è Seguridad activa: Cabeceras L7 aplicadas correctamente.');
}
---

<html lang="es">
  <head>
    <!-- Componente Maestro: Cerebro SEO -->
    <SEO bundle={bundle} />

    <!-- RUM: Core Web Vitals (Observabilidad Permanente) -->
    {ops?.rum?.enabled && (
      <script is:inline>
        const sendToAnalytics = ({ name, value, id }) => {
          const body = JSON.stringify({ name, value, id, url: window.location.href });
          if (navigator.sendBeacon) {
            navigator.sendBeacon('/api/metrics', body);
          } else {
            fetch('/api/metrics', { body, method: 'POST', keepalive: true });
          }
          console.log(`[RUM] üìä ${name}: ${value}`);
        };

        if ('PerformanceObserver' in window) {
          try {
            const po = new PerformanceObserver((list) => {
              for (const entry of list.getEntries()) {
                if (['largest-contentful-paint', 'layout-shift', 'first-input'].includes(entry.entryType)) {
                   sendToAnalytics({
                     name: entry.entryType,
                     value: entry.startTime || entry.value,
                     id: entry.name
                   });
                }
              }
            });
            po.observe({ type: 'largest-contentful-paint', buffered: true });
            po.observe({ type: 'layout-shift', buffered: true });
            po.observe({ type: 'first-input', buffered: true });
          } catch (e) {
            console.error('[RUM] Error initializing observer:', e);
          }
        }
      </script>
    )}

    <!-- Speculation Rules: Velocidad Radical -->
    <!-- Speculation Rules: Velocidad Radical (0ms Navigation) -->
    <script type="speculationrules">
    {
      "prerender": [
        {
          "source": "list",
          "urls": ["/"],
          "score": 0.5
        },
        {
          "where": { 
            "and": [
              { "href_matches": "/*" },
              { "not": { "href_matches": ["/api/*", "/admin/*"] } }
            ]
          },
          "eagerness": "moderate"
        }
      ]
    }
    </script>
  </head>
  <body>
    <slot />
  </body>
</html>