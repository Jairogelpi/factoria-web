name: üöÄ F√°brica SEO 100% Autom√°tica
on:
  repository_dispatch:
    types: [deploy_new_site]

jobs:
  fabricar:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Clonar Plantilla
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Inyectar Bundle y Validar (Observabilidad)
        run: |
          echo "[OBS-FACTORY] üìù Recibiendo datos para: ${{ github.event.client_payload.business_slug }}"
          mkdir -p src/data
          echo '${{ github.event.client_payload.seo_bundle }}' > src/data/current_bundle.json
          npm install
          echo "[OBS-FACTORY] üîç Validando SEO t√©cnico..."
          npm run validate # Esto corre tu script gate.mjs
          
      - name: üèóÔ∏è Crear Repositorio √önico
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          SLUG="${{ github.event.client_payload.business_slug }}"
          REPO_NAME="sitio-$SLUG"
          rm -rf .git
          git init -b main
          git config user.name "Factoria-Bot"
          git config user.email "bot@factoria-web.com"
          git add .
          git commit -m "Initial commit for $SLUG - SEO 2026 Ready"
          gh repo create "$REPO_NAME" --public --source=. --remote=upstream --push
          echo "[OBS-FACTORY] ‚úÖ Repositorio creado: jairogelpi/$REPO_NAME"

      - name: üåê Conectar a Cloudflare Pages
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          SLUG="${{ github.event.client_payload.business_slug }}"
          REPO_NAME="sitio-$SLUG"
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT/pages/projects" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"$REPO_NAME\",
              \"production_branch\": \"main\",
              \"source\": {
                \"type\": \"github\",
                \"config\": {
                  \"owner\": \"jairogelpi\",
                  \"repo_name\": \"$REPO_NAME\",
                  \"production_branch\": \"main\",
                  \"deploy_on_push\": true
                }
              },
              \"build_config\": {
                \"build_command\": \"npm install && npm run build\",
                \"destination_dir\": \"dist\",
                \"root_dir\": \"\"
              }
            }"
          echo "[OBS-FACTORY] üöÄ Web enviada a Cloudflare: https://$REPO_NAME.pages.dev"
